/**
 * @file test_heating_pid.cpp
 * @brief Heating Pad PID Temperature Control Test
 * 
 * Features:
 * - Read MAX31855 temperature
 * - PID control heating pad to maintain target temperature (default 40°C)
 * - Real-time display of temperature, power, PID parameters
 * - Adjust target temperature via serial commands
 * 
 * Serial Commands:
 * - t<temp>: Set target temperature, e.g. "t45" sets to 45°C
 * - p: Print current status
 * - r: Reset PID
 * - e: Enable heating
 * - d: Disable heating
 * 
 * Usage:
 * 1. Compile and upload
 * 2. Open serial monitor
 * 3. Send commands
 */

#include <Arduino.h>
#include "config.h"
#include "TemperatureSensor.h"
#include "HeatingController.h"

// LED 引脚
#define LED_PIN 8

// 对象
TemperatureSensor* tempSensor;
HeatingController* heatingCtrl;

// 目标温度
float targetTemp = 40.0f;

void setup() {
    // 初始化串口
    Serial.begin(115200);
    
    uint32_t startTime = millis();
    while (!Serial && (millis() - startTime < 3000)) {
        delay(10);
    }
    delay(500);
    
    pinMode(LED_PIN, OUTPUT);
    
    Serial.println("\n\n========================================");
    Serial.println("Heating Pad PID Temperature Control Test");
    Serial.println("========================================");
    Serial.printf("Chip: %s @ %dMHz\n", ESP.getChipModel(), ESP.getCpuFreqMHz());
    Serial.println("========================================\n");
    
    // Initialize sensor
    Serial.println("Initializing MAX31855...");
    tempSensor = new TemperatureSensor(THERMO_CLK_PIN, THERMO_CS_PIN, THERMO_MISO_PIN);
    
    if (!tempSensor->begin()) {
        Serial.println("MAX31855 initialization failed!");
        while (1) {
            digitalWrite(LED_PIN, !digitalRead(LED_PIN));
            delay(100);
        }
    }
    Serial.println("MAX31855 initialized successfully");
    
    // Initialize heating controller
    Serial.println("Initializing heating controller...");
    heatingCtrl = new HeatingController(HEATING_PAD_PIN, PWM_CHANNEL_HEAT);
    heatingCtrl->begin();
    heatingCtrl->setTargetTemperature(targetTemp);
    heatingCtrl->enable();
    
    Serial.println("Heating controller initialized successfully");
    Serial.println();
    
    Serial.println("PID Parameters:");
    Serial.println("  Kp = 20.0");
    Serial.println("  Ki = 1.0");
    Serial.println("  Kd = 2.0");
    Serial.println();
    
    Serial.printf("Target Temperature: %.1fC\n", targetTemp);
    Serial.println("\nSerial Commands:");
    Serial.println("  t<temp> - Set target temperature (e.g. t45)");
    Serial.println("  p - Print status");
    Serial.println("  r - Reset PID");
    Serial.println("  e - Enable heating");
    Serial.println("  d - Disable heating");
    Serial.println("  kp<value> - Set Kp (e.g. kp15)");
    Serial.println("  ki<value> - Set Ki (e.g. ki0.5)");
    Serial.println("  kd<value> - Set Kd (e.g. kd2)");
    Serial.println("\nStarting temperature control...\n");
    
    digitalWrite(LED_PIN, HIGH);
    delay(500);
    digitalWrite(LED_PIN, LOW);
}

void loop() {
    static uint32_t lastUpdate = 0;
    static uint32_t updateCount = 0;
    
    // 每秒更新一次
    if (millis() - lastUpdate >= 1000) {
        lastUpdate = millis();
        updateCount++;
        
        // Read temperature
        float currentTemp = tempSensor->readTemperature();
        
        if (!isnan(currentTemp)) {
            // PID control
            uint8_t pwmOutput = heatingCtrl->update(currentTemp);
            float powerPercent = heatingCtrl->getPowerPercent();
            
            // LED indication (solid when near target, blinking otherwise)
            float error = abs(currentTemp - targetTemp);
            if (error < 1.0f) {
                digitalWrite(LED_PIN, HIGH);
            } else {
                digitalWrite(LED_PIN, (millis() / 500) % 2);
            }
            
            // Print status
            Serial.printf("[%lu] ", millis()/1000);
            Serial.printf("Current: %.2fC | ", currentTemp);
            Serial.printf("Target: %.1fC | ", targetTemp);
            Serial.printf("Error: %+.2fC | ", currentTemp - targetTemp);
            Serial.printf("Power: %3.0f%% | ", powerPercent);
            Serial.printf("PWM: %3d/255", pwmOutput);
            
            // Status indicator
            if (error < 0.5f) {
                Serial.print(" [STABLE]");
            } else if (currentTemp < targetTemp) {
                Serial.print(" [HEATING]");
            } else {
                Serial.print(" [COOLING]");
            }
            
            Serial.println();
            
            // Detailed info every 10 cycles
            if (updateCount % 10 == 0) {
                Serial.println("\n--- Detailed Status ---");
                Serial.printf("Uptime: %lu seconds\n", millis()/1000);
                Serial.printf("Current Temp: %.2fC\n", currentTemp);
                Serial.printf("Target Temp: %.1fC\n", targetTemp);
                Serial.printf("Temperature Error: %+.2fC\n", currentTemp - targetTemp);
                Serial.printf("Heating Power: %.1f%%\n", powerPercent);
                Serial.printf("PWM Output: %d/255\n", pwmOutput);
                Serial.printf("Free Memory: %d KB\n", ESP.getFreeHeap()/1024);
                Serial.println("----------------------\n");
            }
            
            // Over-temperature protection
            if (currentTemp >= TEMP_EMERGENCY_STOP) {
                Serial.println("\n!!! EMERGENCY STOP: Temperature too high !!!");
                heatingCtrl->emergencyStop();
                // Fast LED blink warning instead of blocking
                digitalWrite(LED_PIN, (millis() / 100) % 2);
            }
            
        } else {
            Serial.println("[ERROR] Temperature read failed!");
            digitalWrite(LED_PIN, !digitalRead(LED_PIN));
        }
    }
    
    // Handle serial commands
    if (Serial.available()) {
        String cmd = Serial.readStringUntil('\n');
        cmd.trim();
        
        if (cmd.length() > 0) {
            char c = cmd.charAt(0);
            
            if (c == 't' || c == 'T') {
                // Set target temperature
                float newTarget = cmd.substring(1).toFloat();
                if (newTarget >= 20.0f && newTarget <= 60.0f) {
                    targetTemp = newTarget;
                    heatingCtrl->setTargetTemperature(targetTemp);
                    Serial.printf("\nTarget temperature set to: %.1fC\n\n", targetTemp);
                } else {
                    Serial.println("\nTemperature range: 20-60C\n");
                }
            }
            else if (c == 'p' || c == 'P') {
                // Print status
                Serial.println("\n=== Current Status ===");
                float currentTemp = tempSensor->readTemperature();
                Serial.printf("Current Temp: %.2fC\n", currentTemp);
                Serial.printf("Target Temp: %.1fC\n", targetTemp);
                Serial.printf("Heating Power: %.1f%%\n", heatingCtrl->getPowerPercent());
                float p, i, d;
                heatingCtrl->getPID(p, i, d);
                Serial.printf("PID: Kp=%.2f, Ki=%.2f, Kd=%.2f\n", p, i, d);
                Serial.printf("Uptime: %lu seconds\n", millis()/1000);
                Serial.println("======================\n");
            }
            else if (c == 'r' || c == 'R') {
                // Reset PID
                heatingCtrl->reset();
                Serial.println("\nPID reset\n");
            }
            else if (c == 'e' || c == 'E') {
                // Enable heating
                heatingCtrl->enable();
                Serial.println("\nHeating enabled\n");
            }
            else if (c == 'd' || c == 'D') {
                // Disable heating
                heatingCtrl->disable();
                Serial.println("\nHeating disabled\n");
            }
            else if (cmd.startsWith("kp") || cmd.startsWith("KP")) {
                // Set Kp
                float newKp = cmd.substring(2).toFloat();
                if (newKp >= 0 && newKp <= 100) {
                    float p, i, d;
                    heatingCtrl->getPID(p, i, d);
                    heatingCtrl->setPID(newKp, i, d);
                } else {
                    Serial.println("\nKp range: 0-100\n");
                }
            }
            else if (cmd.startsWith("ki") || cmd.startsWith("KI")) {
                // Set Ki
                float newKi = cmd.substring(2).toFloat();
                if (newKi >= 0 && newKi <= 50) {
                    float p, i, d;
                    heatingCtrl->getPID(p, i, d);
                    heatingCtrl->setPID(p, newKi, d);
                } else {
                    Serial.println("\nKi range: 0-50\n");
                }
            }
            else if (cmd.startsWith("kd") || cmd.startsWith("KD")) {
                // Set Kd
                float newKd = cmd.substring(2).toFloat();
                if (newKd >= 0 && newKd <= 50) {
                    float p, i, d;
                    heatingCtrl->getPID(p, i, d);
                    heatingCtrl->setPID(p, i, newKd);
                } else {
                    Serial.println("\nKd range: 0-50\n");
                }
            }
            else {
                Serial.println("\nUnknown command\n");
            }
        }
    }
}
