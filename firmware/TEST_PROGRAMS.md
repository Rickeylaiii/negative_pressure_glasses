# 测试程序使用说明

本目录包含多个独立的测试程序，用于分别测试系统的各个模块。

## 测试程序列表

| 测试文件 | 功能说明 | 测试内容 |
|---------|---------|---------|
| `test_max31855.cpp.bak` | 温度传感器测试 | MAX31855 K型热电偶读取 |
| `test_heating_pid.cpp.bak` | 加热控制测试 | 温度PID控制（40°C恒温） |
| `test_xgzp6897d.cpp.bak` | 压力传感器测试 | XGZP6897D 气压读取 |
| `test_pressure_pid.cpp.bak` | 负压控制测试 | 压力PID控制（15mmHg负压） |
| `test_buttons.cpp.bak` | 按键测试 | STOP/UP/DOWN按键功能 |
| `test_buzzer.cpp.bak` | 蜂鸣器测试 | 无源蜂鸣器音效 |

## 使用方法

### 1. 切换测试程序

要运行某个测试程序，需要：

```powershell
# 1. 备份当前 main.cpp
Rename-Item .\src\main.cpp .\src\main.cpp.bak

# 2. 复制测试程序为 main.cpp（以温度测试为例）
Copy-Item .\src\test_max31855.cpp.bak .\src\main.cpp

# 3. 编译上传
pio run -t upload

# 4. 打开串口监视器
pio device monitor
```

### 2. 恢复主程序

测试完成后，恢复主程序：

```powershell
# 删除测试程序
Remove-Item .\src\main.cpp

# 恢复原始 main.cpp
Rename-Item .\src\main.cpp.bak .\src\main.cpp
```

## 各测试程序详细说明

### 1. test_max31855.cpp - 温度传感器测试

**功能**：
- 初始化 MAX31855 SPI 接口
- 每秒读取一次温度
- 显示温度值和故障信息
- LED 指示读取状态

**硬件连接**：
- SCK: GPIO4
- MISO: GPIO5
- CS: GPIO7

**预期输出**：
```
[1] 读取 #1: 25.50 °C [正常范围]
[2] 读取 #2: 25.75 °C [正常范围]
```

---

### 2. test_heating_pid.cpp - 加热PID控制测试

**功能**：
- 读取温度并进行 PID 控制
- 维持目标温度（默认40°C）
- 实时显示温度、功率、PID参数
- 支持串口命令调节

**串口命令**：
- `t<温度>`: 设置目标温度，如 `t45` 设置为45°C
- `p`: 打印当前状态
- `r`: 重置 PID
- `e`: 启用加热
- `d`: 禁用加热

**预期输出**：
```
[10] 当前: 38.50°C | 目标: 40.0°C | 误差: -1.50°C | 功率: 65% | PWM: 166/255 [加热中]
```

---

### 3. test_xgzp6897d.cpp - 压力传感器测试

**功能**：
- 初始化 XGZP6897D I2C 接口
- 每秒读取一次气压
- 显示 mmHg 和 kPa 单位
- 统计最大/最小/平均值

**硬件连接**：
- SDA: GPIO8
- SCL: GPIO9
- I2C地址: 0x6D

**串口命令**：
- `r`: 重置统计数据
- `s`: 显示统计信息
- `h`: 帮助

**预期输出**：
```
[1] 读取 #1: -15.23 mmHg (-2.03 kPa) [负压]
```

---

### 4. test_pressure_pid.cpp - 负压PID控制测试

**功能**：
- 读取气压并控制负压泵
- 维持目标负压（默认-15mmHg）
- 支持自动/手动控制模式
- 实时显示压力和泵速

**串口命令**：
- `p<压力>`: 设置目标负压，如 `p20` 表示-20mmHg
- `s<速度>`: 手动设置泵速度 0-100，如 `s60`
- `on`: 启动泵
- `off`: 停止泵
- `auto`: 自动控制模式
- `manual`: 手动控制模式
- `t`: 打印状态

**预期输出**：
```
[10] 当前: -14.50 mmHg | 目标: -15.0 mmHg | 误差: -0.50 mmHg | 泵速: 50% [自动] [稳定]
```

---

### 5. test_buttons.cpp - 按键功能测试

**功能**：
- 测试 STOP/UP/DOWN 三个按键
- 模拟档位调节（1-10档）
- 模拟急停功能
- LED 指示系统状态

**按键定义**：
- STOP (GPIO10): 急停，低电平触发
- UP (GPIO20): 增加档位
- DOWN (GPIO21): 减少档位

**串口命令**：
- `s`: 显示当前状态
- `g<档位>`: 设置档位，如 `g5`
- `h`: 帮助

**预期输出**：
```
[100] UP 按键按下
  → 档位增加: 6/10 (60%)
```

---

### 6. test_buzzer.cpp - 蜂鸣器测试

**功能**：
- 测试不同频率和节奏
- 播放提示音、警告音、错误音
- 播放简单旋律
- 支持自定义频率和时长

**硬件连接**：
- 蜂鸣器: GPIO6
- PWM通道: 2

**串口命令**：
- `1`: 短促提示音
- `2`: 警告音
- `3`: 错误报警音
- `4`: 播放旋律
- `5`: 启动音
- `f<频率>`: 指定频率，如 `f1000` 播放1000Hz
- `t<时长>`: 发声指定时长，如 `t500` 播放500ms
- `off`: 停止发声
- `test`: 自动测试所有音效

**预期输出**：
```
[命令] 1
播放: 短促提示音
完成
```

## 测试建议顺序

1. **test_max31855.cpp** - 先确认温度传感器工作正常
2. **test_xgzp6897d.cpp** - 确认压力传感器工作正常
3. **test_buttons.cpp** - 确认按键功能正常
4. **test_buzzer.cpp** - 确认蜂鸣器工作正常
5. **test_heating_pid.cpp** - 测试加热控制（需要温度传感器）
6. **test_pressure_pid.cpp** - 测试负压控制（需要压力传感器）

## 故障排除

### 传感器读取失败
- 检查接线是否正确
- 检查电源是否稳定
- 使用万用表测量传感器电源
- 检查 I2C/SPI 通信引脚

### 控制器不工作
- 检查 PWM 输出引脚
- 检查负载是否连接
- 检查电源容量是否足够
- 使用示波器检查 PWM 波形

### 按键无响应
- 检查按键接线
- 检查上拉/下拉电阻
- 测量按键按下时的电平
- 检查防抖设置

### 蜂鸣器无声
- 确认使用的是无源蜂鸣器
- 检查接线和电源
- 尝试不同频率（1000-3000Hz）
- 检查 PWM 输出

## 注意事项

1. **安全第一**：测试加热和负压功能时注意安全，避免烫伤
2. **电源要求**：确保电源能够提供足够的电流
3. **串口波特率**：统一使用 115200
4. **USB CDC**：如果串口无输出，尝试禁用 USB CDC
5. **内存监控**：注意观察可用内存，避免内存溢出

## 技术支持

如遇到问题，请检查：
- `platformio.ini` 配置是否正确
- 引脚定义是否与硬件匹配
- 依赖库是否正确安装
- ESP32-C3 固件版本是否兼容
